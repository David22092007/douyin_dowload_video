/**
 * Douyin_Search_Exporter - Fixed & Optimized
 */

const getSearchData = async function(keyword, offset) {
    // API search c·ªßa Douyin
    const url = `https://www.douyin.com/aweme/v1/web/search/item/?device_platform=webapp&aid=6383&channel=channel_pc_web&keyword=${encodeURIComponent(keyword)}&offset=${offset}&count=20&version_code=170400&version_name=17.4.0`;

    try {
        const res = await fetch(url, {
            headers: {
                "accept": "application/json, text/plain, */*",
                "referer": `https://www.douyin.com/search/${encodeURIComponent(keyword)}`,
            },
            method: "GET",
            credentials: "include"
        });

        if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
        return await res.json();
    } catch (e) {
        console.error("L·ªói t·∫£i d·ªØ li·ªáu:", e);
        return null;
    }
};

const runSearchExport = async function() {
    const urlParams = new URLSearchParams(window.location.search);
    let keyword = urlParams.get('keyword') || prompt("Nh·∫≠p t·ª´ kh√≥a c·∫ßn l·∫•y link:");
    
    if (!keyword) return;

    let result = [];
    let offset = 0;
    let hasMore = 1;
    let maxPages = 5; // B·∫°n c√≥ th·ªÉ tƒÉng s·ªë n√†y n·∫øu mu·ªën l·∫•y nhi·ªÅu h∆°n
    let currentPage = 0;

    console.log(`üöÄ B·∫Øt ƒë·∫ßu qu√©t t·ª´ kh√≥a: ${keyword}`);

    while (hasMore == 1 && currentPage < maxPages) {
        console.log(`‚è≥ ƒêang t·∫£i trang ${currentPage + 1}, offset = ${offset}...`);
        const data = await getSearchData(keyword, offset);

        if (!data) {
            console.log("‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ho·∫∑c b·ªã ch·∫∑n.");
            break;
        }

        // D·ªØ li·ªáu video th∆∞·ªùng n·∫±m trong data.data ho·∫∑c data.aweme_list t√πy phi√™n b·∫£n API
        const items = data.data || data.aweme_list || [];
        
        if (items.length === 0) {
            console.log("‚ö†Ô∏è H·∫øt k·∫øt qu·∫£ t√¨m ki·∫øm.");
            break;
        }

        items.forEach(item => {
            // Ki·ªÉm tra c·∫•u tr√∫c object ƒë·ªÉ l·∫•y share_url
            const awemeInfo = item.aweme_info || item;
            if (awemeInfo && awemeInfo.share_info && awemeInfo.share_info.share_url) {
                let shareUrl = awemeInfo.share_info.share_url;
                result.push(shareUrl.split('?')[0]); // L·∫•y link s·∫°ch kh√¥ng c√≥ tham s·ªë theo d√µi
            }
        });

        hasMore = data.has_more;
        offset += 20; 
        currentPage++;

        console.log(`‚úÖ ƒê√£ thu th·∫≠p: ${result.length} video`);
        
        // Ngh·ªâ 2.5 gi√¢y ƒë·ªÉ tr√°nh b·ªã Douyin ph√°t hi·ªán bot
        await new Promise(r => setTimeout(r, 2500)); 
    }

    if (result.length > 0) {
        console.log("üíæ Ho√†n th√†nh! ƒêang chu·∫©n b·ªã file t·∫£i v·ªÅ...");
        const uniqueLinks = [...new Set(result)]; // Lo·∫°i b·ªè link tr√πng n·∫øu c√≥
        const blob = new Blob([uniqueLinks.join('\n')], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = window.URL.createObjectURL(blob);
        
        // S·ª¨A L·ªñI T·∫†I ƒê√ÇY: Ch·ªâ ƒë·∫∑t t√™n file ng·∫Øn g·ªçn
        a.download = `douyin_links_${keyword.replace(/\s+/g, '_')}.txt`;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    } else {
        console.log("‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.");
    }
};

// Th·ª±c thi script
runSearchExport();
